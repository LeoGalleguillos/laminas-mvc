<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>v2.X to v2.7 - laminas-mvc</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">laminas-mvc</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../intro/" class="nav-link">Introduction</a>
                            </li>
                            <li class="navitem">
                                <a href="../../quick-start/" class="nav-link">Quick Start</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../services/" class="dropdown-item">Default Services</a>
</li>
                                    
<li>
    <a href="../../routing/" class="dropdown-item">Routing</a>
</li>
                                    
<li>
    <a href="../../mvc-event/" class="dropdown-item">The MVC Event</a>
</li>
                                    
<li>
    <a href="../../send-response-event/" class="dropdown-item">The SendResponse Event</a>
</li>
                                    
<li>
    <a href="../../controllers/" class="dropdown-item">Available Controllers</a>
</li>
                                    
<li>
    <a href="../../plugins/" class="dropdown-item">Controller Plugins</a>
</li>
                                    
<li>
    <a href="../../examples/" class="dropdown-item">Examples</a>
</li>
                                    
<li>
    <a href="../../middleware/" class="dropdown-item">Dispatching PSR-7 Middleware</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Migration</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../" class="dropdown-item">Migration Overview</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">v2.X to v2.7</a>
</li>
            
<li>
    <a href="../to-v3-0/" class="dropdown-item">v2.X to v3.0</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../cookbook/automating-controller-factories/" class="dropdown-item">Automating controller factories</a>
</li>
                                    
<li>
    <a href="../../cookbook/middleware-in-listeners/" class="dropdown-item">Using middleware within event listeners</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../to-v3-0/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/laminas/laminas-mvc/edit/master/docs/migration/to-v2-7.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#upgrading-to-27" class="nav-link">Upgrading to 2.7</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#middleware" class="nav-link">Middleware</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#application" class="nav-link">Application</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#eventmanageraware-initializers" class="nav-link">EventManagerAware initializers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#servicelocatoraware-initializers" class="nav-link">ServiceLocatorAware initializers</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="upgrading-to-27">Upgrading to 2.7</h1>
<h2 id="middleware">Middleware</h2>
<p>laminas-mvc now registers <code>Laminas\Mvc\MiddlewareListener</code> as a dispatch listener at
a priority higher than <code>Laminas\Mvc\DispatchListener</code>, allowing dispatch of
<a href="http://www.php-fig.org/psr/psr-7/">PSR-7</a> middleware. Read the
<a href="../../middleware/">middleware chapter</a> for details on how to use this new feature.</p>
<h2 id="application">Application</h2>
<p>The constructor signature of <code>Laminas\Mvc\Application</code> has changed. Previously, it
was:</p>
<pre><code class="php">__construct($configuration, ServiceManager $serviceManager)
</code></pre>

<p>and internally, it pulled the services <code>EventManager</code>, <code>Request</code>, and <code>Response</code>
from the provided <code>$serviceManager</code> during initialization.</p>
<p>The new constructor signature provides optional arguments for injecting the
event manager, request, and response:</p>
<pre><code class="php">__construct(
    $configuration,
    ServiceManager $serviceManager,
    EventManager $events = null,
    RequestInterface $request = null,
    ResponseInterface $response = null
)
</code></pre>

<p>This change makes all dependencies explicit. Starting in v3.0, the new arguments
will be <em>required</em>.</p>
<p>The factory <code>Laminas\Mvc\Service\ApplicationFactory</code> was updated to follow the new
signature.</p>
<p>This change should only affect users who are manually instantiating the
<code>Application</code> instance.</p>
<h2 id="eventmanageraware-initializers">EventManagerAware initializers</h2>
<p>laminas-mvc provides two mechanisms for injecting event managers into
<code>EventManagerAware</code> objects. One is the "EventManagerAwareInitializer"
registered in <code>Laminas\Mvc\Service\ServiceManagerConfig</code>, and the other is the
<code>Laminas\Mvc\Controller\ControllerManager::injectEventManager()</code> initializer. In
both cases, the logic was updated to be forwards compatible with
laminas-eventmanager v3.</p>
<p>Previously each would check if the instance's <code>getEventManager()</code> method
returned an event manager instance, and, if so, inject the shared event manager:</p>
<pre><code class="php">$events = $instance-&gt;getEventManager();
if ($events instanceof EventManagerInterface) {
    $events-&gt;setSharedManager($container-&gt;get('SharedEventManager'));
}
</code></pre>

<p>In laminas-eventmanager v3, event managers are now injected with the shared
manager at instantiation, and no setter exists for providing the shared manager.
As such, the above logic changed to:</p>
<pre><code class="php">$events = $instance-&gt;getEventManager();
if (! $events || ! $events-&gt;getSharedManager()) {
    $instance-&gt;setEventManager($container-&gt;get('EventManager'));
}
</code></pre>

<p>In other words, it re-injects with a new event manager instance if the instance
pulled does not have a shared manager composed.</p>
<p>This likely will not cause regressions in existing code, but may be something to
be aware of if you were previously depending on lazy-loaded event manager
state.</p>
<h2 id="servicelocatoraware-initializers">ServiceLocatorAware initializers</h2>
<p>laminas-servicemanager v3.0 removes <code>Laminas\ServiceManager\ServiceLocatorAwareInterface</code>.
Since laminas-mvc provides initializers around that interface, they needed updates
to allow both forwards compatibility with laminas-servicemanager v3 as well as
backwards compatibility with existing applications.</p>
<p>This was accomplished in two ways:</p>
<ul>
<li>The abstract controller implementations no longer implement
  <code>ServiceLocatorAwareInterface</code>, but continue to define the methods that the
  interface defines (namely <code>setServiceLocator()</code> and <code>getServiceLocator()</code>.</li>
<li>The initializers registered by <code>Laminas\Mvc\Service\ServiceManagerConfig</code> and
  <code>Laminas\Mvc\Controller\ControllerManager</code> now use duck-typing to determine if
  an instance requires container injection; if so it will do so.</li>
</ul>
<p>However, we also maintain that service locator injection is an anti-pattern;
dependencies should be injected directly into instances instead. As such,
starting in 2.7.0, we now emit a deprecation notice any time an instance is
injected by one of these initializers, and we plan to remove the initializers
for version 3.0. The deprecation notice includes the name of the class, to help
you identify what instances you will need to update before the laminas-mvc v3
release.</p>
<p>To prepare your code, you will need to do the following within your controller:</p>
<ul>
<li>Find all cases where you call <code>getServiceLocator()</code>, and identify the services
  they retrieve.</li>
<li>Update your controller to accept these services via the constructor.</li>
<li>If you have not already, create a factory class for your controller.</li>
<li>In the factory, pull the appropriate services and pass them to the
  controller's constructor.</li>
</ul>
<p>As an example, consider the following code from a controller:</p>
<pre><code class="php">$db = $this-&gt;getServiceLcoator()-&gt;get('Db\ApplicationAdapter');
</code></pre>

<p>To update your controller, you will:</p>
<ul>
<li>Add a <code>$db</code> property to your class.</li>
<li>Update the constructor to accept the database adapter and assign it to the
  <code>$db</code> property.</li>
<li>Change the above line to either read <code>$db = $this-&gt;db;</code> <em>or just use the
  property directly</em>.</li>
<li>Add a factory that pulls the service and pushes it into the controller.</li>
</ul>
<p>The controller then might look like the following:</p>
<pre><code class="php">use Laminas\Db\Adapter\AdapterInterface;
use Laminas\Mvc\Controller\AbstractActionController;

class YourController extends AbstractActionController
{
    private $db;

    public function __construct(AdapterInterface $db)
    {
        $this-&gt;db = $db;
    }

    public function someAction()
    {
        $results = $this-&gt;db-&gt;query(/* ... */);
        /* ... */
    }
}
</code></pre>

<p>A factory would look like the following:</p>
<pre><code class="php">use Interop\Container\ContainerInterface;

class YourControllerFactory
{
    public function __invoke(ContainerInterface $container)
    {
        return new YourController($container-&gt;get('Db\ApplicationAdapter'));
    }
}
</code></pre>

<p>You then also need to ensure the controller manager knows about the factory. It
likely already does, as an invokable; you will redefine it as a factory in
your <code>module.config.php</code>:</p>
<pre><code class="php">return [
    'controllers' =&gt; [
        'factories' =&gt; [
            YourController::class =&gt; YourControllerFactory::class,
            /* ... */
        ],
        /* ... */
    ],
    /* ... */
];
</code></pre>

<p>While this may seem like more steps, doing so ensures your code has no hidden
dependencies, improves the testability of your code, and allows you to substitute
alternatives for either the dependencies or the controller itself.</p>
<h4 id="optional-dependencies">Optional dependencies</h4>
<p>In some cases, you may have dependencies that are only required for some
execution paths, such as forms, database adapters, etc. In these cases, you have
two approaches you can use:</p>
<ul>
<li>Split your controller into separate responsibilities, and use the more
  specific controllers. This way you don't need to inject dependencies that are
  only used in some actions. (We recommend doing this regardless, as it helps
  keep your code more maintainable.)</li>
<li>Use <a href="http://docs.laminas.dev/laminas-servicemanager/lazy-services/">lazy services</a>.
  When you configure these, laminas-servicemanager gives you a proxy instance that,
  on first access, loads the full service. This allows you to delay the most
  expensive operations until absolutely needed.</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <div class="table-responsive"><table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
